<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Label Widget</title>
<style>
body{margin:0;padding:20px;font-family:system-ui;background:#f0f0f0}
@import url('https://fonts.googleapis.com/css2?family=Kalam:wght@700&display=swap');

.label{width:7cm;height:4cm;border:3px solid transparent;background:#fff;overflow:hidden;display:flex;flex-direction:column;margin-top:10px}
.label.border{border-color:#000}
.label.size-8x5{width:8cm;height:5cm}
.label [data-adj]{--tx:0%;--ty:0%;transform:translate(var(--tx),var(--ty));transition:transform 120ms}
.label.debug [data-adj]{outline:1px dashed rgba(200,0,0,.65)}

.title{font-family:'Kalam',cursive;font-weight:700;font-size:18px;line-height:1;white-space:nowrap;margin:0;transform-origin:left center;transform:translate(var(--tx),var(--ty)) scaleX(var(--sx,1))}
.label.size-8x5 .title{font-size:24px}

.top{height:50%;width:100%;padding:0 1mm;box-sizing:border-box;display:flex;flex-direction:column;justify-content:space-between}
.title-area{height:30%;display:flex;align-items:center;overflow:hidden}
.ing-area{height:35%;display:flex;align-items:flex-start;gap:2mm}
.ing-box{flex:1;border:1px solid #000;padding:.5mm 1.5mm;line-height:1.1;font-family:Consolas,monospace;font-size:8.5px;box-sizing:border-box;overflow:hidden}
.label.size-8x5 .ing-box{font-size:10.5px}
.ruid{font-family:'Palatino Linotype',serif;font-size:9px;white-space:nowrap;flex-shrink:0;padding-top:1mm}
.label.size-8x5 .ruid{font-size:11px}
.date-area{height:35%;display:flex;align-items:flex-end;gap:2mm}
.date{font-family:Consolas,monospace;font-size:8.5px;margin:0;line-height:1.2;white-space:nowrap;flex-shrink:0}
.label.size-8x5 .date{font-size:10.5px}
.meat{font-family:Consolas,monospace;font-size:6.5px;font-weight:bold;line-height:1.1;text-align:right;margin:0;flex:1;word-wrap:break-word}
.label.size-8x5 .meat{font-size:8.5px}

.bot{height:50%;width:100%;padding:0 1mm 1mm;box-sizing:border-box;display:flex;gap:2mm}
.qr-area{width:45%;height:100%;display:flex;align-items:center;gap:1mm}
.qr{height:100%;width:auto;max-width:85%;object-fit:contain}
.scan{writing-mode:vertical-rl;font-size:10px;font-weight:bold;letter-spacing:.5px;line-height:1;flex-shrink:0}
.label.size-8x5 .scan{font-size:12px}

.nutr-area{width:55%;height:100%;display:flex;flex-direction:column;font-family:Consolas,monospace}
.nutr-hdr{font-weight:bold;font-size:7.5px;padding:.3mm 1mm .5mm;white-space:nowrap;flex-shrink:0}
.nutr-wrap{flex:1;display:flex}
.nutr{border-collapse:collapse;width:100%;height:100%;font-size:7.5px}
.label.size-8x5 .nutr{font-size:9.5px}
.nutr th,.nutr td{padding:.3mm 1mm;border:1px solid #000;text-align:right;white-space:nowrap;height:25%}
.nutr th{text-align:left;background:#f0f0f0;font-weight:bold;border-right:none;width:60%}
.nutr td{border-left:none;width:40%}

.ctrl{display:flex;gap:12px;align-items:center;padding:8px 12px;background:#fff;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:10px;font-size:12px;flex-wrap:wrap}
.grp{display:flex;align-items:center;gap:6px}
.grp label{color:#555;font-weight:500;margin:0}
select,input[type="number"]{padding:4px 8px;border:1px solid #ddd;border-radius:4px;background:#fff;font-size:12px}
input[type="checkbox"]{width:16px;height:16px;cursor:pointer}
input[type="range"]{width:120px}
.small{width:44px;padding:3px 6px;border:1px solid #ddd;border-radius:4px;font-size:12px}
.btn{padding:6px 8px;border-radius:4px;border:1px solid #ccc;background:#fafafa;cursor:pointer}
.status{padding:8px 12px;font-size:12px;color:#666;background:#fff;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.err{color:#d32f2f}

@media print{
  body{margin:0;padding:0;background:none}
  .ctrl,.status{display:none!important}
  .label{margin:0;position:absolute;top:0;left:0}
}
</style>
</head>
<body>

<button class="btn" onclick="toggleUI()">Nascondi UI</button>

<div class="ctrl" id="ctrls">
  <div class="grp">
    <label>Dim:</label>
    <select id="size" onchange="changeSize(this.value)">
      <option value="7x4">7×4cm</option>
      <option value="8x5">8×5cm</option>
    </select>
  </div>
  <div class="grp">
    <input type="checkbox" id="bord" onchange="toggleBorder(this.checked)">
    <label for="bord">Bordo</label>
  </div>
  <div class="grp">
    <label>Alt top:</label>
    <input type="range" min="10" max="90" value="50" oninput="updateTop(this.value)">
    <span id="topVal">50%</span>
  </div>
  <div class="grp">
    <input type="checkbox" id="dbg" onchange="toggleDebug(this.checked)">
    <label for="dbg">Debug</label>
  </div>
  <div class="grp">
    <label>Elem:</label>
    <select id="elem" onchange="selElem(this.value)">
      <option value="label">Etichetta</option>
      <option value="top">Top</option>
      <option value="title">Titolo</option>
      <option value="ing">Ingredienti</option>
      <option value="ruid">RUID</option>
      <option value="date-area">Data/Carne</option>
      <option value="meat">Carne txt</option>
      <option value="bot">Bottom</option>
      <option value="qr-area">QR area</option>
      <option value="qr">QR img</option>
      <option value="scan">INQUADRA</option>
      <option value="nutr-area">Nutr area</option>
      <option value="nutr">Tabella</option>
    </select>
  </div>
  <button class="btn" onclick="reset()">Reset</button>
</div>

<div class="ctrl" id="sliders">
  <div class="grp">
    <label>X</label>
    <input type="range" min="-200" max="200" value="0" oninput="adj('x',this.value)">
    <input class="small" type="number" value="0" oninput="adj('x',this.value)">
  </div>
  <div class="grp">
    <label>Y</label>
    <input type="range" min="-200" max="200" value="0" oninput="adj('y',this.value)">
    <input class="small" type="number" value="0" oninput="adj('y',this.value)">
  </div>
  <div class="grp">
    <label>W</label>
    <input type="range" min="10" max="200" value="100" oninput="adj('w',this.value)">
    <input class="small" type="number" value="100" oninput="adj('w',this.value)">
  </div>
  <div class="grp">
    <label>H</label>
    <input type="range" min="5" max="200" value="100" oninput="adj('h',this.value)">
    <input class="small" type="number" value="100" oninput="adj('h',this.value)">
  </div>
  <div class="grp">
    <label>Font</label>
    <input type="range" min="6" max="36" value="" oninput="adjFont(this.value)">
    <input class="small" type="number" value="" oninput="adjFont(this.value)">
  </div>
  <button class="btn" onclick="snap()">Snap</button>
  <button class="btn" onclick="save()">Salva</button>
</div>

<div id="status" class="status">Caricamento...</div>

<div class="label" id="lbl" data-adj>
  <div class="top" id="top" data-adj>
    <div class="title-area">
      <div class="title" id="title" data-adj style="--sx:1"></div>
    </div>
    <div class="ing-area">
      <div class="ing-box" id="ing" data-adj></div>
      <div class="ruid" id="ruid" data-adj></div>
    </div>
    <div class="date-area" id="date-area" data-adj>
      <div class="date" id="date" data-adj></div>
      <div class="meat" id="meat" data-adj></div>
    </div>
  </div>
  
  <div class="bot" id="bot" data-adj>
    <div class="qr-area" id="qr-area" data-adj>
      <img class="qr" id="qr" data-adj alt="QR" src="https://i.imgur.com/80f5Lgm.jpg"/>
      <div class="scan" id="scan" data-adj>INQUADRA</div>
    </div>
    <div class="nutr-area" id="nutr-area" data-adj>
      <div class="nutr-hdr">Valori nutrizionali 100g</div>
      <div class="nutr-wrap">
        <table class="nutr" id="nutr" data-adj></table>
      </div>
    </div>
  </div>
</div>

<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
<script>
const MACRO=[
  {name:'Ricette_AVG_Proteine100g_Cooked',label:'Proteine'},
  {name:'Ricette_AVG_Grassi100g_Cooked',label:'Grassi'},
  {name:'Ricette_AVG_Carboidrati100g_Cooked',label:'Carboidrati'},
  {name:'Ricette_AVG_Minerali100g_Cooked',label:'Sale'}
];
const MEAT='Equivalente_Carn_Fresca_GriglieMD';
const QR='Ricette_QR_Code_Cover';
const BASE=['Ricette_Nome_Gusto','Ricette_R_UID','Ricette_Ingredeienti_semplificati','Numero_Lotto_GriglieMetaData_Date',MEAT,QR,'Ricette','Numero_Lotto_GriglieMetaData'];
const COLS=BASE.concat(MACRO.map(c=>c.name));

let sel='label',ui=1;
const elMap={label:'lbl',top:'top',title:'title',ing:'ing',ruid:'ruid','date-area':'date-area',date:'date',meat:'meat',bot:'bot','qr-area':'qr-area',qr:'qr',scan:'scan','nutr-area':'nutr-area',nutr:'nutr'};
const getEl=k=>document.getElementById(elMap[k]||k);

function adj(t,v){
  const e=getEl(sel);if(!e)return;
  const n=Number(v);
  const sl=document.querySelector(`#sliders input[type="range"]`);
  const inp=document.querySelector(`#sliders input[type="number"]`);
  if(t==='x'){e.style.setProperty('--tx',`${n}%`)}
  if(t==='y'){e.style.setProperty('--ty',`${n}%`)}
  if(t==='w'){e.style.width=`${n}%`;e.style.flexBasis=`${n}%`}
  if(t==='h'){e.style.height=`${n}%`}
}

function adjFont(v){
  const e=getEl(sel);if(!e)return;
  const n=Number(v);if(isNaN(n)||n<=0)return;
  e.style.fontSize=`${n}px`;
}

function reset(){
  const e=getEl(sel);if(!e)return;
  e.style.removeProperty('--tx');
  e.style.removeProperty('--ty');
  e.style.removeProperty('width');
  e.style.removeProperty('height');
  e.style.removeProperty('flex-basis');
  e.style.removeProperty('font-size');
  if(sel==='title'){e.style.setProperty('--sx',1);requestAnimationFrame(()=>scaleTit(e))}
}

function toggleDebug(c){getEl('label').classList.toggle('debug',c)}
function snap(){const e=getEl(sel);if(!e)return;e.style.width='100%';e.style.height='100%';e.style.removeProperty('--tx');e.style.removeProperty('--ty')}
function save(){try{localStorage.setItem('lbl_state',JSON.stringify({sel:document.getElementById('lbl').innerHTML}));alert('Salvato')}catch(e){}}
function selElem(k){sel=k}
function updateTop(v){document.getElementById('top').style.height=`${v}%`;document.getElementById('bot').style.height=`${100-v}%`;document.getElementById('topVal').textContent=v+'%'}
function changeSize(s){const l=getEl('label');l.classList.toggle('size-8x5',s==='8x5');requestAnimationFrame(()=>scaleTit(getEl('title')))}
function toggleBorder(c){getEl('label').classList.toggle('border',c)}
function toggleUI(){ui=!ui;document.querySelectorAll('.ctrl').forEach(c=>c.style.display=ui?'flex':'none')}

function scaleTit(e){
  const w=e.parentElement;if(!w)return;
  e.style.setProperty('--sx',1);
  const cw=e.scrollWidth,ww=w.clientWidth;
  if(cw>ww)e.style.setProperty('--sx',ww/cw);
  else e.style.setProperty('--sx',1);
}

function fmt(v,g=1,d=2){
  if(v==null||v==='')return'N/D';
  const n=Number(v);
  if(isNaN(n))return'N/D';
  let f=n.toLocaleString('it-IT',{minimumFractionDigits:d,maximumFractionDigits:d});
  return g?f+'g':f;
}

function find(r,c){
  let v=r[c];
  if(v!=null)return v;
  if(r.Ricette&&r.Ricette[c]!=null)return r.Ricette[c];
  if(r.Numero_Lotto_GriglieMetaData&&r.Numero_Lotto_GriglieMetaData[c]!=null)return r.Numero_Lotto_GriglieMetaData[c];
  if(MACRO.some(m=>m.name===c)){
    if(r.Ricette){
      const m=c.match(/AVG_(\w+)/);
      if(m&&r.Ricette[m[0]]!=null)return r.Ricette[m[0]];
    }
  }
  return null;
}

grist.ready({columns:COLS.map(name=>({name,optional:true})),requiredAccess:'read table'});

grist.onRecord(async(r)=>{
  const st=document.getElementById('status'),lb=getEl('label');
  try{
    st.style.display='none';lb.style.display='flex';
    const tit=find(r,'Ricette_Nome_Gusto')||'NO DATA';
    const ru=find(r,'Ricette_R_UID')||'---';
    const ing=find(r,'Ricette_Ingredeienti_semplificati');
    const dt=find(r,'Numero_Lotto_GriglieMetaData_Date');
    const mt=find(r,MEAT);
    const qr=find(r,QR);
    const qrUrl=(qr&&qr.startsWith('http'))?qr:'https://i.imgur.com/80f5Lgm.jpg';
    
    const te=getEl('title');te.textContent=tit;requestAnimationFrame(()=>scaleTit(te));
    getEl('ruid').textContent=ru;
    getEl('ing').textContent=ing?`ingredienti: ${ing}`:'ingredienti: N/D';
    getEl('date').innerHTML=dt?`prodotto il:<br>${dt}`:'prodotto il:<br>---';
    getEl('meat').textContent=`100g carne secca = ${fmt(mt,0,0)}g carne fresca`;
    getEl('qr').src=qrUrl;
    
    let html='';
    MACRO.forEach(c=>{
      const v=find(r,c.name);
      html+=`<tr><th>${c.label}</th><td>${fmt(v,1,2)}</td></tr>`;
    });
    getEl('nutr').innerHTML=html;
  }catch(e){
    console.error(e);
    lb.style.display='none';
    st.innerHTML=`<span class="err">Errore: ${e.message}</span>`;
    st.style.display='block';
  }
});
</script>
</body>
</html>