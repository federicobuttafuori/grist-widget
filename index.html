<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grist Label Designer</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}html,body{height:100vh;width:100vw;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column;overflow:hidden;background:#f0f0f0;color:#333}button{padding:6px 10px;border:1px solid #ccc;background:#fff;border-radius:4px;cursor:pointer;font-size:14px;transition:all .2s}button:hover{background:#f9f9f9;border-color:#aaa}button:active{background:#e0e0e0}button:disabled{opacity:.5;cursor:not-allowed}input,select,textarea{width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:14px}textarea{resize:vertical;min-height:60px}hr{border:none;border-top:1px solid #eee;margin:12px 0}#toolbar{flex-shrink:0;padding:8px;background:#fff;border-bottom:1px solid #e0e0e0;display:flex;gap:8px;align-items:center;flex-wrap:wrap}#toolbar .zoom-label{font-size:14px;margin-left:auto}#toolbar .divider{width:1px;height:24px;background:#e0e0e0;margin:0 4px}#main-content{display:flex;flex-grow:1;overflow:hidden}#sidebar{width:280px;flex-shrink:0;background:#fdfdfd;border-right:1px solid #e0e0e0;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:16px}#sidebar h3{font-size:16px;font-weight:600;border-bottom:1px solid #eee;padding-bottom:6px;margin-bottom:4px}.sidebar-section{display:flex;flex-direction:column;gap:8px}.sidebar-section .add-buttons{display:grid;grid-template-columns:1fr 1fr;gap:8px}.prop-grid{display:grid;grid-template-columns:70px 1fr;gap:8px;align-items:center}.prop-grid label{font-size:14px;font-weight:500}.prop-full{grid-column:1/-1}#properties-panel{font-size:14px}#btn-delete{background:#fbebeb;border-color:#d9a0a0;color:#c00;margin-top:12px}#btn-delete:hover{background:#f7dada}.button-group{display:flex;gap:4px}#canvas-container{flex-grow:1;display:flex;justify-content:center;align-items:center;overflow:auto;background:#e0e0e0;padding:20px}#canvas-wrapper{display:inline-block;transform-origin:center center}#label-canvas{width:8cm;height:5cm;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.15);position:relative;overflow:hidden}@media print{@page{size:8cm 5cm;margin:0}html,body{margin:0!important;padding:0!important;width:8cm!important;height:5cm!important;overflow:hidden!important}body *{visibility:hidden!important}#canvas-wrapper,#canvas-wrapper *{visibility:visible!important}#canvas-wrapper{position:absolute!important;left:0!important;top:0!important;width:8cm!important;height:5cm!important;margin:0!important;padding:0!important;transform:none!important}#label-canvas{position:absolute!important;left:0!important;top:0!important;width:8cm!important;height:5cm!important;transform:none!important;box-shadow:none!important}.label-element.selected{border:none!important;box-shadow:none!important}.resize-handle{display:none!important}}.label-element{position:absolute;cursor:move;border:1px solid transparent;font-size:16px;line-height:1.2;overflow:hidden;word-wrap:break-word;user-select:none}.label-element.selected{border:2px dashed #007aff;box-shadow:0 0 0 1px rgba(0,122,255,.1)}.resize-handle{position:absolute;width:12px;height:12px;background:#007aff;border:2px solid #fff;border-radius:50%;bottom:-6px;right:-6px;cursor:nwse-resize;display:none;box-shadow:0 2px 4px rgba(0,0,0,.2)}.label-element.selected .resize-handle{display:block}.label-element img,.label-element svg{width:100%;height:100%;object-fit:contain;pointer-events:none}.status-message{position:fixed;top:60px;right:20px;padding:12px 16px;background:#4CAF50;color:#fff;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.2);z-index:1000;animation:slideIn .3s ease-out}@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}.status-message.error{background:#f44336}
    </style>
</head>
<body>
    <div id="toolbar">
        <button id="btn-save" title="Save Layout">üíæ Save</button>
        <button id="btn-load" title="Load Layout">üìÇ Load</button>
        <button id="btn-clear" title="Clear Layout">üóëÔ∏è Clear</button>
        <div class="divider"></div>
        <button id="btn-print" title="Print Label">üñ®Ô∏è Print</button>
        <div class="divider"></div>
        <button id="btn-duplicate" title="Duplicate Selected Element" disabled>üìã Duplicate</button>
        <button id="btn-bring-front" title="Bring to Front" disabled>‚¨ÜÔ∏è Front</button>
        <button id="btn-send-back" title="Send to Back" disabled>‚¨áÔ∏è Back</button>
        <span class="zoom-label">Zoom:</span>
        <div class="button-group">
            <button id="btn-zoom-out" title="Zoom Out">-</button>
            <button id="btn-zoom-in" title="Zoom In">+</button>
            <button id="btn-zoom-fit" title="Fit to Screen">Fit</button>
        </div>
        <span id="zoom-display">100%</span>
    </div>
    <div id="main-content">
        <div id="sidebar">
            <div class="sidebar-section">
                <h3>Add Element</h3>
                <div class="add-buttons">
                    <button class="add-element" data-type="text">üìù Text</button>
                    <button class="add-element" data-type="data">üåêüîó Data Field</button>
                    <button class="add-element" data-type="qr">üì± QR Code</button>
                    <button class="add-element" data-type="barcode">üìä Barcode</button>
                    <button class="add-element" data-type="line">‚ûñ Line</button>
                    <button class="add-element" data-type="box">‚¨ú Box</button>
                </div>
            </div>
            <hr>
            <div class="sidebar-section">
                <h3>Properties</h3>
                <div id="properties-panel">Select an element to edit its properties.</div>
            </div>
        </div>
        <div id="canvas-container">
            <div id="canvas-wrapper">
                <div id="label-canvas"></div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded',()=>{let S=[],E=null,z=1,R={},C=[],drag=false,resize=false,ctx={};const W=8,H=5,KEY='grist_label_layout',cc=document.getElementById('canvas-container'),cw=document.getElementById('canvas-wrapper'),lc=document.getElementById('label-canvas'),pp=document.getElementById('properties-panel'),zd=document.getElementById('zoom-display'),bd=document.getElementById('btn-duplicate'),bf=document.getElementById('btn-bring-front'),bs=document.getElementById('btn-send-back');function msg(m,e=false){const x=document.querySelector('.status-message');if(x)x.remove();const s=document.createElement('div');s.className='status-message'+(e?' error':'');s.textContent=m;document.body.appendChild(s);setTimeout(()=>s.remove(),3000)}function updateBtns(){const h=E!==null;bd.disabled=!h;bf.disabled=!h;bs.disabled=!h}function fmt(v,d,p){if(v===null||v===undefined||v==='')return '';let n=parseFloat(v);if(isNaN(n))return String(v);if(p)n=n*100;n=n.toFixed(d);return p?n+'%':n}function render(){lc.innerHTML='';S.forEach(el=>{const d=document.createElement('div');d.classList.add('label-element');d.dataset.id=el.id;d.style.left=`${el.x}cm`;d.style.top=`${el.y}cm`;d.style.width=`${el.width}cm`;d.style.height=`${el.height}cm`;d.style.zIndex=el.zIndex||0;d.style.fontSize=`${el.props.fontSize||16}px`;d.style.fontWeight=el.props.fontWeight||'normal';d.style.fontFamily=el.props.fontFamily||'Arial, sans-serif';d.style.textAlign=el.props.textAlign||'left';d.style.color=el.props.color||'#000000';let c='';switch(el.type){case 'text':c=el.props.text||'Static Text';d.innerText=c;break;case 'data':c=getData(el);d.innerText=c;break;case 'line':d.style.backgroundColor=el.props.color||'#000000';d.style.height=`${el.props.thickness||2}px`;d.style.width=`${el.width}px`;break;case 'box':d.style.border=`${el.props.thickness||2}px solid ${el.props.color||'#000000'}`;d.style.backgroundColor=el.props.fillColor||'transparent';break;case 'qr':c=getData(el);const q=document.createElement('img');const qs=Math.min(el.width,el.height);q.src=`https://api.qrserver.com/v1/create-qr-code/?size=${Math.round(qs)}x${Math.round(qs)}&data=${encodeURIComponent(c)}`;q.style.pointerEvents='none';q.style.width='100%';q.style.height='100%';q.style.objectFit='contain';d.appendChild(q);break;case 'barcode':c=getData(el);const sv=document.createElementNS('http://www.w3.org/2000/svg','svg');sv.style.pointerEvents='none';d.appendChild(sv);try{JsBarcode(sv,c,{format:el.props.format||"CODE128",displayValue:el.props.displayValue!==false,width:2,height:Math.max(30,el.height-10),margin:0})}catch(e){sv.innerHTML=`<text x="10" y="20" fill="red" font-size="12">Invalid barcode</text>`;console.error("Barcode Error:",e)}break}if(el.id===E){d.classList.add('selected');const h=document.createElement('div');h.classList.add('resize-handle');d.appendChild(h)}lc.appendChild(d)})}function getData(el){if(el.props.boundColumn&&R[el.props.boundColumn]){let v=R[el.props.boundColumn];if(el.type==='data'&&typeof v==='number'){const dec=el.props.decimals!==undefined?el.props.decimals:2;const pct=el.props.asPercent||false;return fmt(v,dec,pct)}return String(v)}return el.props.text||'SAMPLE'}function select(id){if(E===id)return;E=id;render();updateProps();updateBtns()}function updateProps(){if(!E){pp.innerHTML='Select an element to edit its properties.';return}const el=S.find(e=>e.id===E);if(!el){pp.innerHTML='Error: Element not found.';return}let h=`<div class="prop-grid"><label>X (cm)</label><input type="number" step="0.1" data-prop="x" value="${el.x.toFixed(2)}"><label>Y (cm)</label><input type="number" step="0.1" data-prop="y" value="${el.y.toFixed(2)}"><label>Width (cm)</label><input type="number" step="0.1" data-prop="width" value="${el.width.toFixed(2)}"><label>Height (cm)</label><input type="number" step="0.1" data-prop="height" value="${el.height.toFixed(2)}"></div><hr>`;if(el.type==='text')h+=`<label>Text</label><textarea data-prop="props.text">${el.props.text||''}</textarea>`;if(el.type==='data'||el.type==='qr'||el.type==='barcode'){let opts=C.map(col=>`<option value="${col}" ${el.props.boundColumn===col?'selected':''}>${col}</option>`).join('');h+=`<label>Bound Column</label><select data-prop="props.boundColumn"><option value="">-- Select Column --</option>${opts}</select>`}if(el.type==='data')h+=`<hr><div class="prop-grid"><label>Decimals</label><input type="number" data-prop="props.decimals" value="${el.props.decimals!==undefined?el.props.decimals:2}" min="0" max="10"><label>As Percent</label><input type="checkbox" data-prop="props.asPercent" ${el.props.asPercent?'checked':''}></div>`;if(el.type==='qr'||el.type==='barcode')h+=`<label>Fallback Text</label><input type="text" data-prop="props.text" value="${el.props.text||''}">`;if(el.type==='barcode')h+=`<label>Format</label><select data-prop="props.format"><option value="CODE128" ${el.props.format==='CODE128'?'selected':''}>CODE128</option><option value="CODE39" ${el.props.format==='CODE39'?'selected':''}>CODE39</option><option value="EAN13" ${el.props.format==='EAN13'?'selected':''}>EAN13</option><option value="UPC" ${el.props.format==='UPC'?'selected':''}>UPC</option></select><label>Show Text</label><input type="checkbox" data-prop="props.displayValue" ${el.props.displayValue!==false?'checked':''}>`;if(el.type==='line')h+=`<label>Thickness</label><input type="number" data-prop="props.thickness" value="${el.props.thickness||2}" min="1">`;if(el.type==='box')h+=`<label>Border</label><input type="number" data-prop="props.thickness" value="${el.props.thickness||2}" min="1"><label>Fill Color</label><input type="color" data-prop="props.fillColor" value="${el.props.fillColor||'#ffffff'}">`;if(el.type==='text'||el.type==='data')h+=`<hr><div class="prop-grid"><label>Font Size</label><input type="number" data-prop="props.fontSize" value="${el.props.fontSize||16}" min="6" max="200"><label>Font Family</label><select data-prop="props.fontFamily"><option value="Arial, sans-serif" ${(el.props.fontFamily||'Arial, sans-serif')==='Arial, sans-serif'?'selected':''}>Arial</option><option value="'Courier New', monospace" ${el.props.fontFamily==="'Courier New', monospace"?'selected':''}>Courier New</option><option value="Consolas, monospace" ${el.props.fontFamily==='Consolas, monospace'?'selected':''}>Consolas</option><option value="Georgia, serif" ${el.props.fontFamily==='Georgia, serif'?'selected':''}>Georgia</option><option value="'Times New Roman', serif" ${el.props.fontFamily==="'Times New Roman', serif"?'selected':''}>Times New Roman</option><option value="Verdana, sans-serif" ${el.props.fontFamily==='Verdana, sans-serif'?'selected':''}>Verdana</option><option value="'Trebuchet MS', sans-serif" ${el.props.fontFamily==="'Trebuchet MS', sans-serif"?'selected':''}>Trebuchet MS</option><option value="Impact, sans-serif" ${el.props.fontFamily==='Impact, sans-serif'?'selected':''}>Impact</option><option value="'Comic Sans MS', cursive" ${el.props.fontFamily==="'Comic Sans MS', cursive"?'selected':''}>Comic Sans MS</option></select><label>Weight</label><select data-prop="props.fontWeight"><option value="normal" ${el.props.fontWeight==='normal'?'selected':''}>Normal</option><option value="bold" ${el.props.fontWeight==='bold'?'selected':''}>Bold</option></select><label>Align</label><select data-prop="props.textAlign"><option value="left" ${el.props.textAlign==='left'?'selected':''}>Left</option><option value="center" ${el.props.textAlign==='center'?'selected':''}>Center</option><option value="right" ${el.props.textAlign==='right'?'selected':''}>Right</option></select></div>`;if(el.type!=='box')h+=`<hr><label>Color</label><input type="color" data-prop="props.color" value="${el.props.color||'#000000'}">`;h+=`<button id="btn-delete">Delete Element</button>`;pp.innerHTML=h}function add(t){const mz=S.length>0?Math.max(...S.map(e=>e.zIndex||0)):0;const n={id:`el_${Date.now()}`,type:t,x:.5,y:.5,width:1.5,height:.5,zIndex:mz+1,props:{text:'Sample Text',fontSize:16,fontWeight:'normal',fontFamily:'Arial, sans-serif',textAlign:'left',color:'#000000',boundColumn:'',thickness:2,format:'CODE128',displayValue:true,fillColor:'#ffffff',decimals:2,asPercent:false}};if(t==='qr'){n.width=1;n.height=1}if(t==='barcode'){n.width=2;n.height=.8}if(t==='line'){n.height=.02;n.width=2}if(t==='box'){n.width=1.5;n.height=1}S.push(n);select(n.id);render()}function dup(){if(!E)return;const el=S.find(e=>e.id===E);if(!el)return;const mz=Math.max(...S.map(e=>e.zIndex||0));const n=JSON.parse(JSON.stringify(el));n.id=`el_${Date.now()}`;n.x=Math.min(el.x+.2,W-el.width);n.y=Math.min(el.y+.2,H-el.height);n.zIndex=mz+1;S.push(n);select(n.id);save()}function front(){if(!E)return;const el=S.find(e=>e.id===E);if(!el)return;const mz=Math.max(...S.map(e=>e.zIndex||0));el.zIndex=mz+1;render();save()}function back(){if(!E)return;const el=S.find(e=>e.id===E);if(!el)return;const mz=Math.min(...S.map(e=>e.zIndex||0));el.zIndex=mz-1;render();save()}function del(){if(!E)return;S=S.filter(el=>el.id!==E);E=null;render();updateProps();updateBtns();save()}function setZoom(nz){z=Math.max(.1,Math.min(3,nz));lc.style.transform=`scale(${z})`;zd.textContent=`${Math.round(z*100)}%`}function fit(){const cr=cc.getBoundingClientRect();const hw=(cr.width-40)/(W*37.795276);const vw=(cr.height-40)/(H*37.795276);setZoom(Math.min(hw,vw,1.5))}async function save(){const d=JSON.stringify(S);try{await grist.setOption(KEY,d);msg('Layout saved successfully!')}catch(e){console.warn("Grist.setOption failed, using localStorage fallback.",e);localStorage.setItem(KEY,d);msg('Layout saved (locally)')}}async function load(){let d=null;try{d=await grist.getOption(KEY)}catch(e){console.warn("Grist.getOption failed, using localStorage fallback.",e);d=localStorage.getItem(KEY)}if(d){try{S=JSON.parse(d);render();msg('Layout loaded successfully!')}catch(e){msg('Error loading layout',true);console.error('Parse error:',e)}}}document.getElementById('btn-save').addEventListener('click',save);document.getElementById('btn-load').addEventListener('click',load);document.getElementById('btn-print').addEventListener('click',()=>{const ws=E;E=null;render();window.print();setTimeout(()=>{E=ws;render()},100)});document.getElementById('btn-clear').addEventListener('click',()=>{if(confirm('Are you sure you want to clear the layout?')){S=[];E=null;render();updateProps();updateBtns();save()}});bd.addEventListener('click',dup);bf.addEventListener('click',front);bs.addEventListener('click',back);document.getElementById('btn-zoom-in').addEventListener('click',()=>setZoom(z*1.25));document.getElementById('btn-zoom-out').addEventListener('click',()=>setZoom(z/1.25));document.getElementById('btn-zoom-fit').addEventListener('click',fit);document.querySelectorAll('.add-element').forEach(b=>{b.addEventListener('click',e=>{add(e.target.dataset.type)})});pp.addEventListener('input',e=>{if(!E)return;const el=S.find(e=>e.id===E);if(!el)return;const t=e.target;const p=t.dataset.prop;let v=t.type==='number'?parseFloat(t.value):t.type==='checkbox'?t.checked:t.value;if(p.includes('.')){const[o,k]=p.split('.');el[o][k]=v}else{el[p]=v}render();save()});pp.addEventListener('click',e=>{if(e.target.id==='btn-delete')del()});lc.addEventListener('mousedown',e=>{const t=e.target;if(t===lc){select(null);return}const te=t.closest('.label-element');if(!te)return;const id=te.dataset.id;select(id);e.preventDefault();const el=S.find(e=>e.id===id);const cr=lc.getBoundingClientRect();const smx=(e.clientX-cr.left)/cr.width*W;const smy=(e.clientY-cr.top)/cr.height*H;if(t.classList.contains('resize-handle')){resize=true;ctx={el,startWidth:el.width,startHeight:el.height,startMouseX:smx,startMouseY:smy}}else{drag=true;ctx={el,offsetX:smx-el.x,offsetY:smy-el.y}}});window.addEventListener('mousemove',e=>{if(!drag&&!resize)return;const cr=lc.getBoundingClientRect();const mx=(e.clientX-cr.left)/cr.width*W;const my=(e.clientY-cr.top)/cr.height*H;const el=ctx.el;if(drag){let nx=mx-ctx.offsetX;let ny=my-ctx.offsetY;el.x=Math.max(0,Math.min(nx,W-el.width));el.y=Math.max(0,Math.min(ny,H-el.height))}else if(resize){const dx=mx-ctx.startMouseX;const dy=my-ctx.startMouseY;let nw=ctx.startWidth+dx;let nh=ctx.startHeight+dy;el.width=Math.max(.2,Math.min(nw,W-el.x));el.height=Math.max(.2,Math.min(nh,H-el.y))}render();updateProps()});window.addEventListener('mouseup',e=>{if(drag||resize)save();drag=false;resize=false;ctx={}});window.addEventListener('keydown',e=>{if(!E)return;if(e.key==='Delete'||e.key==='Backspace'){if(e.target.tagName!=='INPUT'&&e.target.tagName!=='TEXTAREA'){e.preventDefault();del()}}if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){if(e.target.tagName!=='INPUT'&&e.target.tagName!=='TEXTAREA'){e.preventDefault();const el=S.find(e=>e.id===E);if(!el)return;const st=e.shiftKey?.1:.01;switch(e.key){case 'ArrowUp':el.y=Math.max(0,el.y-st);break;case 'ArrowDown':el.y=Math.min(H-el.height,el.y+st);break;case 'ArrowLeft':el.x=Math.max(0,el.x-st);break;case 'ArrowRight':el.x=Math.min(W-el.width,el.x+st);break}render();updateProps();save()}}if((e.ctrlKey||e.metaKey)&&e.key==='d'){e.preventDefault();dup()}});            grist.ready({requiredAccess:'full',allowSelectBy:true});async function updateFromGrist(){try{const record=await grist.fetchSelectedRecord();console.log('fetchSelectedRecord result:',record);if(record&&Object.keys(record).length>0){R=record;const nc=Object.keys(record);console.log('Columns found:',nc);if(JSON.stringify(nc)!==JSON.stringify(C)){C=nc;console.log('Columns updated to:',C);if(E){updateProps()}}render()}else{console.warn('No record data received')}}catch(e){console.error('Error fetching record:',e)}}grist.onRecord((record,mappings)=>{console.log('onRecord called with:',record);if(record){R=record;const nc=Object.keys(record);if(JSON.stringify(nc)!==JSON.stringify(C)){C=nc;if(E){updateProps()}}render()}});grist.onRecords((records,mappings)=>{console.log('onRecords called with:',records);if(records&&records.length>0){R=records[0];const nc=Object.keys(records[0]);if(JSON.stringify(nc)!==JSON.stringify(C)){C=nc;if(E){updateProps()}}render()}});setInterval(updateFromGrist,500);load().then(()=>{fit();setTimeout(updateFromGrist,500)});updateBtns()})
    </script>
</body>
</html>